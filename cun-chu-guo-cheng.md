# 存储过程

## 存储过程

#### 存储过程是预编译, 相当于定义了一个函数, 调用就会运行.

#### 存储过程是作用在选定的库上的

### 优点

* 存储过程增强了SQL语言的功能和灵活性
* 允许标准组件是编程的.
* 存储过程能实现较快的执行速度
* 存储过程能减少网络流量
* 存储过程可被是为一种安全机制来充分利用

### 创建存储过程

```sql
#1. 首先选中一个数据库, 注意: 创建的存储过程, 只能在选中的这个库内执行!!!!
        mysql> use  库;

#2. 改变分隔符功能  ;    不让其成为执行结束的标记. 主要是为了后面的步骤.
        # 执行完毕后,分号结尾就无用了,  必须使用  $$  来进行语句结尾.( 或者使用 $$; )
                mysql>  delimiter 
                        $$;        # 独占一行 这样使用就需要分号, 否则不需要分号
                mysql>  SHOW TABLES 
                        $$;    #语句要这样写.

#3. 创建存储过程,关键词是 procedure, 随后的参数是自定义的过程名字和括号内的参数,就当函数看.
        # 参数关键字:  in 输入参数(不可返回),无论存储过程如何运算.原参数的本值不变,
           #         out 输出参数(可返回), 这个值是传出参数,只作为结果(return),无论什么,默认值都是NULL
           #         inout 输入输出参数(可返回), 可计算可返回.
                #参数使用:  关键字 变量名字  类型 
        mysql> CREATE PROCEDURE  
                hello_p(in p int,out d int ,inout c int )    #  名字是 hello_p,参数: in 输入参数,名字是p 类型int
                begin              #从这里开始向下到 end  ,当成函数体看.
                SELECT 'hello';     # 上面改变了分隔符, 所以这里不会直接执行,而是继续向下读取
                SELECT p,d,c;        # 除了这些, 还可以添加局部变量之类的内容;
                SET p = p+1;     # 让p 等于 p+1
                SELECT  COUNT(*) INTO d FROM README;  # 将查询的结果,输出到d参数里面去.而不会输出到屏幕上.
                SET c = 50;
                SELECT p,d,c;    # 再次输出
                end  
                $$;           # 两个 $$; 才是分隔符,

#4. 存错过程创建完成后, 需要恢复分隔符的功能,然后才可以执行刚刚创建的存储过程.
        mysql> delimiter ;        #执行完毕之后可能没有返回值.这是正常的.(报错就是你关键字打错了)

#5. 执行存储过程. 说白了就是一个函数调用.
        mysql> call hello_p();      # 调用函数名, 如果我括号内有参数,那么需要用括号带上参数.
        mysql> call hello_p(参数1,参数2,参数3);   #调用有参数的 存储过程
 

  # 根据上面的存储过程定义, 调用后会打印如下结果,(完全就是将两个语句进行封装嘛,跟函数封装没区别)
mysql>   SET  @t1 = 4,@t2 = 10 ,@t3 = 13;
mysql>   call p_hello(@t1,@t2.@t3);     
+-------+
| hello |
+-------+
| hello |
+-------+
1 row in set (0.01 sec)

+------+------+------+
| p    | d    | c    |
+------+------+------+
|    4 | NULL |   50 |
+------+------+------+
1 row in set (0.01 sec)

+------+------+------+
| p    | d    | c    |
+------+------+------+
|    5 |   34 |   50 |
+------+------+------+
1 row in set (0.02 sec)


# @t1 的值没有改变(in).  @t2 被覆盖式的改变了 原值被清空(out), @t3 也改变了 (inout)

mysql> SELECT @t1,@t2,@t3;
+------+------+------+
| @t1  | @t2  | @t3  |
+------+------+------+
|    4 |   34 |   50 |
+------+------+------+
1 row in set (0.01 sec)


```

### 恢复分隔符功能

```sql
mysql> delimiter ;       
```

### 执行存储过程

```sql
# 执行之前 ,需要恢复分隔符功能. 否则会失败
mysql> call  hello_p ;                  #无参数, 存储过程名是 hello_p
mysql> call  hello_p(参数1,参数2);       #有参数的调用
```

### 删除存储过程

```sql
MySQL中使用DROP PROCEDURE语句来删除存储过程.
mysql>   DROP PROCEDURE  p_hello;     #后面是存储过程名
```

## 还可以使用SET 设置一个局部变量来传入进去

库作用域;

```sql
mysql>  SET @变量名字= 初始值 ;       #这个名字随便设置, 初始值也可以是任意类型.
                            # 这个值可以用来直接调用,还可以用来当作存储过程参数
mysql>  call p_hello(@变量名字);
mysql>  SELECT @变量名字;        #这样可以直接打印这个变量的值.
```

